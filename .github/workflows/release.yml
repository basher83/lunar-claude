name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  PYTHON_VERSION: "3.13"
  UV_VERSION: "0.9.13"

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7
        with:
          version: ${{ env.UV_VERSION }}

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Validate marketplace structure
        run: uv run scripts/verify-structure.py --strict

      - name: Run tests
        run: uv run pytest scripts/tests/ -v --tb=short

  release:
    name: Create Release
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Install git-cliff
        uses: taiki-e/install-action@f176c07a0a40cbfdd08ee9aa8bf1655701d11e69 # v2
        with:
          tool: git-cliff

      - name: Generate release notes
        id: changelog
        run: |
          # Get the current tag
          TAG="${GITHUB_REF#refs/tags/}"

          # Generate changelog for this release only
          git-cliff --config cliff.toml --latest --strip header > RELEASE_NOTES.md

          # Output for GitHub Release
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          name: ${{ steps.changelog.outputs.tag }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
