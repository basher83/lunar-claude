{
  "name": "check-docs-staleness",
  "description": "Check if Claude Code documentation is stale and prompt for updates",
  "trigger": "SessionStart",
  "enabled": true,
  "config": {
    "mode": "interactive",
    "staleness_days": 7
  },
  "script": "#!/usr/bin/env bash\nset -euo pipefail\n\n# Load config\nMODE=$(jq -r '.config.mode // \"interactive\"' < \"$HOOK_CONFIG_FILE\")\nSTALENESS_DAYS=$(jq -r '.config.staleness_days // 7' < \"$HOOK_CONFIG_FILE\")\n\n# Find ai_docs directory (auto-detect like script does)\nSCRIPT_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\nPLUGIN_DIR=\"$(dirname \"$SCRIPT_DIR\")\"\nAI_DOCS_DIR=\"$PLUGIN_DIR/ai_docs\"\n\n# Check if cache file exists\nCACHE_FILE=\"$AI_DOCS_DIR/.download_cache.json\"\n\nif [ ! -f \"$CACHE_FILE\" ]; then\n  # No cache exists - docs never downloaded\n  if [ \"$MODE\" = \"auto\" ]; then\n    # Auto mode: download silently\n    \"$PLUGIN_DIR/tools/claude_docs.py\" --format json\n  else\n    # Interactive mode: ask user\n    # Use AskUserQuestion tool to prompt\n    cat <<EOF\n{\n  \"tool\": \"AskUserQuestion\",\n  \"params\": {\n    \"questions\": [{\n      \"question\": \"No Claude Code documentation found locally. Download now?\",\n      \"header\": \"Docs Setup\",\n      \"multiSelect\": false,\n      \"options\": [\n        {\n          \"label\": \"Yes, download now\",\n          \"description\": \"Download default documentation pages (~14 pages, ~3-5 seconds)\"\n        },\n        {\n          \"label\": \"No, skip\",\n          \"description\": \"Continue without updating documentation\"\n        },\n        {\n          \"label\": \"Auto-update going forward\",\n          \"description\": \"Download now and enable automatic updates in the future\"\n        }\n      ]\n    }]\n  }\n}\nEOF\n    \n    # Wait for user response (injected by hook system)\n    RESPONSE=\"${HOOK_USER_RESPONSE:-}\"\n    \n    if [[ \"$RESPONSE\" == *\"Yes\"* ]]; then\n      \"$PLUGIN_DIR/tools/claude_docs.py\" --format json\n    elif [[ \"$RESPONSE\" == *\"Auto-update\"* ]]; then\n      # Enable auto mode\n      jq '.config.mode = \"auto\"' < \"$HOOK_CONFIG_FILE\" > \"${HOOK_CONFIG_FILE}.tmp\"\n      mv \"${HOOK_CONFIG_FILE}.tmp\" \"$HOOK_CONFIG_FILE\"\n      \"$PLUGIN_DIR/tools/claude_docs.py\" --format json\n    fi\n  fi\n  exit 0\nfi\n\n# Cache exists - check staleness\nLAST_UPDATE=$(jq -r '[.[] | .downloaded_at] | max' < \"$CACHE_FILE\")\nCURRENT_TIME=$(date +%s)\nAGE_SECONDS=$((CURRENT_TIME - ${LAST_UPDATE:-0}))\nAGE_DAYS=$((AGE_SECONDS / 86400))\n\nif [ \"$AGE_DAYS\" -lt \"$STALENESS_DAYS\" ]; then\n  # Docs are fresh\n  exit 0\nfi\n\n# Docs are stale\nif [ \"$MODE\" = \"auto\" ]; then\n  # Auto mode: update silently\n  RESULT=$(\"$PLUGIN_DIR/tools/claude_docs.py\" --format json)\n  # Parse JSON result and show brief status\n  DOWNLOADED=$(echo \"$RESULT\" | jq -r '.downloaded')\n  DURATION=$(echo \"$RESULT\" | jq -r '.duration_seconds')\n  echo \"✓ Docs updated ($DOWNLOADED pages, ${DURATION}s)\"\nelse\n  # Interactive mode: ask user\n  cat <<EOF\n{\n  \"tool\": \"AskUserQuestion\",\n  \"params\": {\n    \"questions\": [{\n      \"question\": \"Claude Code documentation is $AGE_DAYS days old. Update now?\",\n      \"header\": \"Docs Stale\",\n      \"multiSelect\": false,\n      \"options\": [\n        {\n          \"label\": \"Yes, update now\",\n          \"description\": \"Download latest documentation (~3-5 seconds)\"\n        },\n        {\n          \"label\": \"No, skip\",\n          \"description\": \"Continue with current documentation\"\n        },\n        {\n          \"label\": \"Auto-update going forward\",\n          \"description\": \"Update now and enable automatic updates\"\n        }\n      ]\n    }]\n  }\n}\nEOF\n  \n  # Wait for user response\n  RESPONSE=\"${HOOK_USER_RESPONSE:-}\"\n  \n  if [[ \"$RESPONSE\" == *\"Yes\"* ]]; then\n    RESULT=$(\"$PLUGIN_DIR/tools/claude_docs.py\" --format json)\n    DOWNLOADED=$(echo \"$RESULT\" | jq -r '.downloaded')\n    DURATION=$(echo \"$RESULT\" | jq -r '.duration_seconds')\n    echo \"✓ Docs updated ($DOWNLOADED pages, ${DURATION}s)\"\n  elif [[ \"$RESPONSE\" == *\"Auto-update\"* ]]; then\n    # Enable auto mode\n    jq '.config.mode = \"auto\"' < \"$HOOK_CONFIG_FILE\" > \"${HOOK_CONFIG_FILE}.tmp\"\n    mv \"${HOOK_CONFIG_FILE}.tmp\" \"$HOOK_CONFIG_FILE\"\n    RESULT=$(\"$PLUGIN_DIR/tools/claude_docs.py\" --format json)\n    DOWNLOADED=$(echo \"$RESULT\" | jq -r '.downloaded')\n    DURATION=$(echo \"$RESULT\" | jq -r '.duration_seconds')\n    echo \"✓ Docs updated, auto-mode enabled ($DOWNLOADED pages, ${DURATION}s)\"\n  fi\nfi\n"
}
